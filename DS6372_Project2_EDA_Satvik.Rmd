---
title: "Project_2_EDA"
author: "Satvik Ajmera"
output: html_notebook
editor_options: 
  chunk_output_type: console
---

The data is related with direct marketing campaigns (phone calls) of a Portuguese banking institution. The classification goal is to predict if the client will subscribe a term deposit (variable y).

  The zip file includes two datasets: 
      1) bank-additional-full.csv with all examples, ordered by date (from May 2008 to November 2010).
      2) bank-additional.csv with 10% of the examples (4119), randomly selected from bank-additional-full.csv.
   The smallest dataset is provided to test more computationally demanding machine learning algorithms (e.g., SVM).

   The binary classification goal is to predict if the client will subscribe a bank term deposit (variable y).

5. Number of Instances: 41188 for bank-additional-full.csv

6. Number of Attributes: 20 + output attribute.

7. Attribute information:

   For more information, read [Moro et al., 2014].

   Input variables:
   # bank client data:
   1 - age (numeric)
   2 - job : type of job (categorical: "admin.","blue-collar","entrepreneur","housemaid","management","retired","self-employed","services","student","technician","unemployed","unknown")
   3 - marital : marital status (categorical: "divorced","married","single","unknown"; note: "divorced" means divorced or widowed)
   4 - education (categorical: "basic.4y","basic.6y","basic.9y","high.school","illiterate","professional.course","university.degree","unknown")
   5 - default: has credit in default? (categorical: "no","yes","unknown")
   6 - housing: has housing loan? (categorical: "no","yes","unknown")
   7 - loan: has personal loan? (categorical: "no","yes","unknown")
   # related with the last contact of the current campaign:
   8 - contact: contact communication type (categorical: "cellular","telephone") 
   9 - month: last contact month of year (categorical: "jan", "feb", "mar", ..., "nov", "dec")
  10 - day_of_week: last contact day of the week (categorical: "mon","tue","wed","thu","fri")
  11 - duration: last contact duration, in seconds (numeric). Important note:  this attribute highly affects the output target (e.g., if duration=0 then y="no"). Yet, the duration is not known before a call is performed. Also, after the end of the call y is obviously known. Thus, this input should only be included for benchmark purposes and should be discarded if the intention is to have a realistic predictive model.
   # other attributes:
  12 - campaign: number of contacts performed during this campaign and for this client (numeric, includes last contact)
  13 - pdays: number of days that passed by after the client was last contacted from a previous campaign (numeric; 999 means client was not previously contacted)
  14 - previous: number of contacts performed before this campaign and for this client (numeric)
  15 - poutcome: outcome of the previous marketing campaign (categorical: "failure","nonexistent","success")
   # social and economic context attributes
  16 - emp.var.rate: employment variation rate - quarterly indicator (numeric)
  17 - cons.price.idx: consumer price index - monthly indicator (numeric)     
  18 - cons.conf.idx: consumer confidence index - monthly indicator (numeric)     
  19 - euribor3m: euribor 3 month rate - daily indicator (numeric)
  20 - nr.employed: number of employees - quarterly indicator (numeric)

  Output variable (desired target):
  21 - y - has the client subscribed a term deposit? (binary: "yes","no")

8. Missing Attribute Values: There are several missing values in some categorical attributes, all coded with the "unknown" label. These missing values can be treated as a possible class label or using deletion or imputation techniques. 


```{r}
library(tidyverse)
library(ggplot2)
library(GGally)
# bank_full.path <- file.choose()
# bank_full = read.csv(bank_full.path, header = TRUE, sep = ";")
bank_full <- read.csv("bank-additional-full.csv", header=TRUE, sep = ';')
head(bank_full)
colnames(bank_full)
bank_full
summary(bank_full)
```
response (y)
has the client subscribed a term deposit?
no: 36548
yes: 4640

```{r}
attach(bank_full)

t(aggregate(y~duration,data=bank_full,summary))
plot(y~duration,col=c("red","blue"))
```

```{r}
#Proportion Tables
prop.table(table(y,job),2)
prop.table(table(y,age),2)
prop.table(table(y,marital),2)
prop.table(table(y,education),2)
prop.table(table(y,duration),2)
prop.table(table(y,campaign),2)
prop.table(table(y,housing),2)
prop.table(table(y,contact),2)
prop.table(table(y,day),2)
prop.table(table(y,month),2)
prop.table(table(y,poutcome),2)
prop.table(table(y,pdays),2)
prop.table(table(y,previous),2)
prop.table(table(y,loan),2)


#Visualize
plot(y~job,col=c("red","blue"))
plot(y~age,col=c("red","blue"))
plot(y~marital,col=c("red","blue"))
#Visualize
plot(y~education,col=c("red","blue"))
plot(y~duration,col=c("red","blue"))
plot(y~marital,col=c("red","blue"))

plot(y~campaign,col=c("red","blue"))
plot(y~housing,col=c("red","blue"))
plot(y~contact,col=c("red","blue"))
plot(y~day,col=c("red","blue"))
plot(y~month,col=c("red","blue"))
plot(y~poutcome,col=c("red","blue"))
plot(y~pdays,col=c("red","blue"))
plot(y~previous,col=c("red","blue"))
plot(y~loan,col=c("red","blue"))
```

```{r}
prop.table(table(y,age),2)
plot(y~age,col=c("purple","white","green"))
table(y,age)
#function for the table above
proportion_plot <- function(predictor) {
  plot(y~predictor,col=c("purple","white","green"))
  table(y,predictor)
}
proportion_plot(balance)
proportion_plot(duration)

```


The data is related with direct marketing campaigns (phone calls) of a Portuguese banking institution. The classification goal is to predict if the client will subscribe a term deposit (variable y).

  The zip file includes two datasets: 
      1) bank-additional-full.csv with all examples, ordered by date (from May 2008 to November 2010).
      2) bank-additional.csv with 10% of the examples (4119), randomly selected from bank-additional-full.csv.
   The smallest dataset is provided to test more computationally demanding machine learning algorithms (e.g., SVM).

   The binary classification goal is to predict if the client will subscribe a bank term deposit (variable y).

5. Number of Instances: 41188 for bank-additional-full.csv

6. Number of Attributes: 20 + output attribute.

7. Attribute information:

   For more information, read [Moro et al., 2014].

   Input variables:
   # bank client data:
   1 - age (numeric)
   2 - job : type of job 
   (categorical: "admin.","blue-collar","entrepreneur","housemaid","management","retired","self-employed","services","student","technician","unemployed","unknown")
   3 - marital: 
   marital status (categorical: "divorced","married","single","unknown"; note: "divorced" means divorced or widowed)
   4 - education 
   (categorical: "basic.4y","basic.6y","basic.9y","high.school","illiterate","professional.course","university.degree","unknown")
   5 - default: has credit in default?(categorical: "no","yes","unknown")
   6 - housing: has housing loan? (categorical: "no","yes","unknown")
   7 - loan: has personal loan? (categorical: "no","yes","unknown")
   # related with the last contact of the current campaign:
   8 - contact: contact communication type (categorical: "cellular","telephone") 
   9 - month: last contact month of year (categorical: "jan", "feb", "mar", ..., "nov", "dec")
  10 - day_of_week: last contact day of the week (categorical: "mon","tue","wed","thu","fri")
  11 - duration: last contact duration, in seconds (numeric). Important note:  this attribute highly affects the output target (e.g., if duration=0 then y="no"). Yet, the duration is not known before a call is performed. Also, after the end of the call y is obviously known. Thus, this input should only be included for benchmark purposes and should be discarded if the intention is to have a realistic predictive model.
   # other attributes:
  12 - campaign: number of contacts performed during this campaign and for this client (numeric, includes last contact)
  13 - pdays: number of days that passed by after the client was last contacted from a previous campaign (numeric; 999 means client was not previously contacted)
  14 - previous: number of contacts performed before this campaign and for this client (numeric)
  15 - poutcome: outcome of the previous marketing campaign (categorical: "failure","nonexistent","success")
   # social and economic context attributes
  16 - emp.var.rate: employment variation rate - quarterly indicator (numeric)
  17 - cons.price.idx: consumer price index - monthly indicator (numeric)     
  18 - cons.conf.idx: consumer confidence index - monthly indicator (numeric)     
  19 - euribor3m: euribor 3 month rate - daily indicator (numeric)
  20 - nr.employed: number of employees - quarterly indicator (numeric)

  Output variable (desired target):
  21 - y - has the client subscribed a term deposit? (binary: "yes","no")

8. Missing Attribute Values: There are several missing values in some categorical attributes, all coded with the "unknown" label. These missing values can be treated as a possible class label or using deletion or imputation techniques. 

```{r}
summary(bank_full)
colnames(bank_full)
```

```{r}
#Histograms by Response Variable Y
ggplot(data = bank_full, aes(x = age,fill = y)) + geom_histogram()+facet_wrap(~y,
scales = "free_y")
ggplot(data = bank_full, aes(x = age,fill = y)) + geom_histogram()+facet_wrap(~y,
scales = "free_y")
ggplot(data = bank_full, aes(x = duration,fill = y)) + geom_histogram()+facet_wrap(~y,
scales = "free_y")
ggplot(data = bank_full, aes(x = duration,fill = y)) + geom_histogram()+facet_wrap(~y,
scales = "free_y")
ggplot(data = bank_full, aes(x = campaign,fill = y)) + geom_histogram()+facet_wrap(~y,
scales = "free_y")
ggplot(data = bank_full, aes(x = emp.var.rate,fill = y)) + geom_histogram()+facet_wrap(~y,
scales = "free_y")
ggplot(data = bank_full, aes(x = emp.var.rate)) + geom_histogram()
t(aggregate(y~age,data=bank_full,summary))

library(GGally)
ggplot(data = bank_full, aes(x = duration)) + geom_histogram()+facet_grid(~y)

```


```{r}
library(ggplot2)
library(gplots)
#removed categorical variables for PCA and checking multicolinearity
newBankAdd <- bank_full[-c(2:10,15)]
summary(newBankAdd)
colnames(newBankAdd)

#Correlations between continuous variables
my.cor<-cor(newBankAdd[,1:10])
my.cor
#Correlation Heatmap
heatmap.2(my.cor,col=redgreen(75), 
          density.info="none", trace="none", dendrogram=c("row"), 
          symm=F,symkey=T,symbreaks=T, scale="none")

mr.cor2 = cor(pc.result)

```

```{r}
pc.result<-prcomp(newBankAdd[,1:10],scale.=TRUE)
pc.scores<-pc.result$x
pc.scores<-data.frame(pc.scores)
pc.scores$y<-newBankAdd$y

#Use ggplot2 to plot the first few pc's
ggplot(data = pc.scores, aes(x = PC1, y = PC2)) +
  geom_point(aes(col=y), size=1)+
  ggtitle("PCA of Bank Full Additional")

ggplot(data = pc.scores, aes(x = PC2, y = PC3)) +
  geom_point(aes(col=y), size=1)+
  ggtitle("PCA of Bank Full Additional")

ggplot(data = pc.scores, aes(x = PC3, y = PC4)) +
  geom_point(aes(col=y), size=1)+
  ggtitle("PCA of Bank Full Additional")

ggplot(data = pc.scores, aes(x = PC7, y = PC8)) +
  geom_point(aes(col=y), size=1)+
  ggtitle("PCA of Bank Full Additional")


ggplot(data = pc.scores, aes(x = PC1, y = PC10)) +
  geom_point(aes(col=y), size=1)+
  ggtitle("PCA of Bank Full Additional")

eigenvals<-(pc.result$sdev)^2

#So we can see some pretty good seperation here.
plot(1:10,eigenvals/sum(eigenvals),type="l",main="Scree Plot PC's",ylab="Prop. Var. Explained",ylim=c(0,1))
cumulative.prop<-cumsum(eigenvals/sum(eigenvals))
lines(1:10,cumulative.prop,lty=2)


```


```{r}
#Pairwise Plot -- takes time to run
#ggpairs(newBankAdd, aes(color = y, alpha = 0.2),lower = list(combo=wrap("facethist",binwidth=0.5)))
attach(newBankAdd)
colnames(newBankAdd)
summary(newBankAdd)
library(plotly)
fig <- plot_ly(x = duration, type = "histogram")

fig <- plot_ly(x = newBankAdd$duration , type = "histogram")
fig <- plot_ly(x = newBankAdd$age, type = "histogram")
fig

plot(duration~y,col=c("red","blue"))
plot(previous~y,col=c("red","blue"))
plot(campaign~y,col=c("red","blue"))
plot(pdays~y,col=c("red","blue"))
plot(euribor3m~y,col=c("red","blue"))
plot(emp.var.rate~y,col=c("red","blue"))
```
Duration,Previous, and Campaign are heavily right skewed.
We will need to transform the variables if choose to keep them.
Campaign has one very large outlier.
P-days is heavily left skewed.
euribor3m is bimodal for yes and no.

```{r}
bank_full_omit <-na.omit(bank_full)
o.newBankAdd <-na.omit(newBankAdd)
model.main<-glm(y ~ ., data=bank_full_omit,family = binomial)
summary(model.main)
library(ResourceSelection)
library(car)
alias(model.main)
#Using this tool, GVIF is the same as VIF for continuous predictors only
#For categorical predictors, the value GVIG^(1/(2*df)) should be squared and interpreted
#as a usuaul vif type metric.The following code can be used to interpret VIFs like we 
#discussed in class.
(vif(model.main))
par(mfrow = c(2, 2))
plot(model.main)
```

```{r}
t(aggregate(euribor3m~y,data=bank_full,summary))
t(aggregate(emp.var.rate~y,data=bank_full,summary))
summary(model.main)
exp(cbind("Odds ratio" = coef(model.main), confint.default(model.main, level = 0.95)))
```

Month is a good predictor in the model, statistically significant and 
```{r}
t(aggregate(month~y,data=bank_full,summary))
t(aggregate(marital~y,data=bank_full,summary))
prop.table(table(y,marital),2)

#looks like there is a higher proportion of no's than yes to some of the types of jobs.
t(aggregate(job~y,data=bank_full,summary))
prop.table(table(y,job),2)

t(aggregate(education~y,data=bank_full,summary))
prop.table(table(y,education),2)

#contact by cellular yield a higher percent of yes compared to telephone
t(aggregate(contact~y,data=bank_full,summary))
prop.table(table(y,contact),2)


```
Socioeconomic variables are potentially multicolinear with variables that are recorded over time?




________________________________________________________________________________________________
```{r}
library(tidyverse)
library(broom)
library(pROC)
library(plotROC) 
library(knitr)
log.bank <- glm(y ~ ., 
              data = newBankAdd, family = binomial)
log.bank
tidy(log.bank, conf.int = TRUE, exponentiate = FALSE) %>% 
  kable(format = "markdown", digits = 3)
```


```{r}

newBankFull <- bank_full[-c(2:5,7:9,11,12,15,16:17)]
summary(newBankFull)
pc.result<-prcomp(newBankFull,scale.=TRUE)
pc.scores<-pc.result$x
pc.scores<-data.frame(pc.scores)
pc.scores$y<-newBankFull$y
eigenvals<-(pc.result$sdev)^2

plot(1:5,eigenvals/sum(eigenvals),type="l",main="Scree Plot PC's",ylab="Prop. Var. Explained",ylim=c(0,1))
cumulative.prop<-cumsum(eigenvals/sum(eigenvals))
lines(1:5,cumulative.prop,lty=2)
#bad seperation using continuous predictors. PCA doesn't help too much here.
ggplot(data = pc.scores, aes(x = PC1, y = PC2)) +
  geom_point(aes(col=y), size=1)+
  ggtitle("PCA of Bank")

```





```{r}
library(ROCR)
library(MASS)
newBankmodel <- bank_full[-c(2:5,7:9,11,12,15,16)]
set.seed(1234)
index<-sample(1:45211,11000,replace=FALSE)
test<-newBankmodel[-index,]
newBankm<-newBankmodel[index,]
mylda<- lda(y ~ age+balance+day+campaign+pdays, data = newBankm)
myqda<- qda(y ~ age+balance+day+campaign+pdays, data = newBankm)
# myqda<- qda(mpg ~ displacement+horsepower+weight+acceleration, data = newAuto)
prd<-predict(mylda, newdata = test)$class
table(prd,test$y)
q.prd<-predict(myqda, newdata = test)$class
table(q.prd,test$y)
```


```{r}
library(aplore3)
?glow_bonemed

bonemed_fu
library(arm)
library(lalonde)
?lalonde
?library(arm)
?arm
install.packages("arm")
packages.install
?binnedplot
```



